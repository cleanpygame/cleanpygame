# Levels Format Design Document

## Data Model

The Clean-Code Game uses a single `levels.json` to store levels and topics.
It is generated by toolchain from a source levels directory with topic descriptions in `JSON` format and level
descriptions in `PyLevels` format.

## Source Levels Directory

```
levels
  - 01-naming
	- topic.json
    - 01-level1.py
	- 02-level2.py
  - 02-decomposition
    - topic.json
    - 01-level1.py
	...
  ...
```

Each directory in `levels` folder with `topic.json` ‚Äî‚Äî is a topic folder.

* folder name defines the order of the topics in game.
* topic.json defines a topic:

  ```json
  {
      "name": "Naming",
      "inDevelopment": true
  }
  ```

Optional `"inDevelopment":true` hides the topic from the UI for all users unless they turn on debug mode (add
?debug=true to the URL)

## ‚úçÔ∏è PyLevels Format (Level Source Format)

Each .py file in the topic directory defines one level. The name of the file defines the order of the levels in the
topic.

Levels file starts with header directives followed by sequence of blocks.

### üîπ Header Directives

```text
##file readable_title.py           # Required ‚Äî used as display title in UI
```

### üîπ Chat Messages

```text
"""start
Smart and maybe sarcastic message from buddy commenting new level. Shown when level is started
"""
##start-reply "Short player's reply ‚Äî text on the reply-button in the chat. Optional"            
"""final
Smart and sarcastic comment about the finished level. Shown after all issues are fixed.
"""
##final-reply "Custom 'Next' button text. Optional"            


```

### üîπ Block Types

##### 1. Plain Text Block

Text not following a directive is treated as a normal block of visible text.

```text
This is a simple explanation or code section.
```

##### 2. Replace Span

Replaces a substring when clicked and triggers EVENT_ID.
If `-` used for EVENT_ID, then toolchain generates unique event id.

```text
##replace-span EVENT_ID CLICKABLE_SUBSTRING REPLACEMENT
```

##### 3. Replace

Replaces one or more lines of code when clicked. Can optionally narrow the clickable area with a substring.

```text
##replace EVENT_ID
<code lines...>
##with
<replacement lines...>
##end
```

With specific clickable area:

```text
##replace EVENT_ID CLICKABLE_SUBSTRING
<code lines...>
##with
<replacement lines...>
##end
```

If `-` used for EVENT_ID or EVENT_ID is missing, then toolchain generates unique event id.

Starting code of the level shows <code lines...> block of every replace block, as well as replace-on, remove-on blocks.

Replace blocks can not be nested. (Implementational restriction may be implemented in the future, but not now)

##### 4. Explanations and Hints

```text
##explain EXPLANATION
```

Can appear only after blocks triggering events: `replace`, `replace-span` or `neutral` block. Add explanation to prev
block.
Contains sarcastic but educating comment on the issue. Shown after the issue was fixed.

```text
##hint EXPLANATION
```

Can appear only after `replace-block` and `replace-span`. Add a hint to prev block.

Contains a smart and short hint that doesn't fully reveal the issue but rather gives a slight hint.

##### 6. Replace On

Replaces a block only **after another event has triggered**. Must reuse an existing EVENT_ID. Can specify multiple
events separated by spaces, in which case the replacement will be triggered if any of the events has occurred.

```text
##replace-on EVENT_ID [EVENT_ID2 EVENT_ID3 ...]
<code lines...>
##with
<replacement lines...>
##end
```

##### 7. Add On (Syntactic Sugar)

```text
##add-on EVENT_ID [EVENT_ID2 EVENT_ID3 ...]
<code lines...>
##end
```

equivalent to

```text
##replace-on EVENT_ID [EVENT_ID2 EVENT_ID3 ...]
##with
<code lines...>
##end
```

Can specify multiple events separated by spaces, in which case the code will be added if any of the events has occurred.

##### 8. Remove On (Syntactic Sugar)

```text
##remove-on EVENT_ID [EVENT_ID2 EVENT_ID3 ...]
<code lines...>
##end
```

equivalent to

```text
##replace-on EVENT_ID [EVENT_ID2 EVENT_ID3 ...]
<code lines...>
##with
##end
```

Can specify multiple events separated by spaces, in which case the code will be removed if any of the events has
occurred.

#### üîê Additional Rules

- **CLICKABLE_SUBSTRING**, **REPLACEMENT**, **EXPLANATION** may be enclosed in quotation marks (single or double).
  In that case (and only in that case) escape sequences and spaces can be used in them to represent multiline substrings
  or substrings with spaces.
- All whitespace and formatting is preserved
- EVENT_ID may be the same for several replacement blocks. In that case triggering any of these blocks executes all the
  replacements with the same EVENT_ID
- CLICKABLE substring occurrence counts only if it is surrounded by word-boundaries.

## üßæ levels.json Format

Web-application work with this json format:

```json
{
  "topics": [
    {
      "name": "Naming",
      "levels": [
      ]
    }
  ]
}
```

Each level is compiled into a single JSON object with the following structure:

```json
{
  "filename": "onboarding.py",
  "chat": {
    "buddy": "Hello, Junior! This is your first task!",
    "reply": "Ok"
  },
  "blocks": [
    {
      "type": "text",
      "text": "val answer: Int = 42\nval question: String? = null"
    },
    {
      "type": "replace-span",
      "clickable": "foo",
      "replacement": "describe_user",
      "event": "rename-function",
      "explanation": "this is optional explanation",
      "hint": "some optional hint"
    },
    {
      "type": "replace",
      "text": "def foo():\n    print('Hello')",
      "replacement": "def describe_user():\n    print('Hello')",
      "event": "rename-function",
      "explanation": "this is optional explanation",
      "hint": "some optional hint"
    },
    {
      "type": "replace-on",
      "text": "print(foo())",
      "replacement": "print(describe_user())",
      "event": "rename-function"
    }
  ]
}
```

This structure is designed for easy rendering in the frontend and consistent mapping from the authoring format.